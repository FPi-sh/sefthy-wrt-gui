{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">{{ get_message('diagnostics') }}</h2>
        
        <div class="mb-6">
            <label class="block text-gray-700 mb-2">{{ get_message('tool') }}</label>
            <select id="tool" class="w-full px-3 py-2 border rounded-lg">
                <option value="ping">Ping</option>
                <option value="traceroute">Traceroute</option>
                <option value="iperf">Connector Speedtest</option>
            </select>
        </div>
        <div class="mb-6">
                <label class="block text-gray-700 mb-2" id="targetlabel">{{ get_message('target') }}</label>
                <input type="text" id="target" class="focus-visible:outline focus-visible:outline-gray-100 w-full px-3 py-2 border rounded-lg">
                <div class="flex items-center bg-blue-400 text-white text-sm px-4 py-4" id="info" role="alert" style="display:none;">
                    <svg class="fill-current w-10 h-10 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.432 0c1.34 0 2.01.912 2.01 1.957 0 1.305-1.164 2.512-2.679 2.512-1.269 0-2.009-.75-1.974-1.99C9.789 1.436 10.67 0 12.432 0zM8.309 20c-1.058 0-1.833-.652-1.093-3.524l1.214-5.092c.211-.814.246-1.141 0-1.141-.317 0-1.689.562-2.502 1.117l-.528-.88c2.572-2.186 5.531-3.467 6.801-3.467 1.057 0 1.233 1.273.705 3.23l-1.391 5.352c-.246.945-.141 1.271.106 1.271.317 0 1.357-.392 2.379-1.207l.6.814C12.098 19.02 9.365 20 8.309 20z"/></svg>
                    <p>{{ get_message('speedtestinfo') }}</p>
                </div>
        </div>
        <button onclick="runDiagnostic()" class="align-middle w-full bg-primary text-white py-2 rounded-lg hover:bg-primary">Run Test</button>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
        <div id="chart" class="p-2 items-center flex h-50" style="display:none;">
            <canvas id="cpuChart"></canvas>
        </div>

        <h3 class="font-bold mb-2">{{ get_message('results') }}</h3>
        <pre id="results" class="bg-gray-100 p-4 rounded-lg whitespace-pre-wrap"></pre>
    </div>
</div>
<a href="{{ url_for('download_logs') }}" style="width: fit-content;position: fixed;bottom: 10px;right: 10px;" class="align-middle w-full bg-red-300 text-white py-2 px-4 rounded-lg hover:bg-red-400">{{ get_message('getlogs') }}</a>

<script src="{{url_for('static', filename='js/chart.js')}}"></script>
<script>
function runDiagnostic() {
    const tool = document.getElementById('tool').value;
    const target = document.getElementById('target').value;
    const results = document.getElementById('results');
    
    results.textContent = '{{ get_message('runningtest') }}...';
    
    fetch('/api/diagnostic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `tool=${tool}&target=${target}`
    })
    .then(response => response.json())
    .then(data => {
        results.textContent = data.result;
    })
    .catch(error => {
        results.textContent = '{{ get_message('runningtesterr') }}: ' + error;
    });
}

document.getElementById('tool').addEventListener('change', function() {
    const targetInput = document.getElementById('target');
    const targetLabel = document.getElementById('targetlabel');
    const infoBox = document.getElementById('info');
    const chartcontainer = document.getElementById('chart');

    results.textContent = '';

    if (this.value === 'iperf') {
        targetInput.value = 'iperf.sefthy.cloud';
        targetInput.disabled=true;
        targetInput.style.display="none"
        targetLabel.style.display="none"
        infoBox.style.display=""
        chartcontainer.style.display=""

    } else {
        targetInput.value = '';
        targetInput.disabled=false;
        targetInput.style.display=""
        targetLabel.style.display=""
        infoBox.style.display="none"
        chartcontainer.style.display="none"
    }

    targetInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            runDiagnostic();
        }
    });
});

let chart;
const maxDataPoints = 11;
let timeLabels = Array(maxDataPoints).fill('');
let cpuData = Array(maxDataPoints).fill(0);

// Inizializza il grafico
function initChart() {
    const ctx = document.getElementById('cpuChart').getContext('2d');

        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 25, // Valore iniziale
                    ticks: {
                        stepSize: 25,
                        callback: function(value) {
                            return value + '% CPU';
                        }
                    }
                },
                x: {
                    display: false
                }
            },
            elements: {
                point: {
                    radius: 0,
                    hitRadius: 10,
                    hoverRadius: 5
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip:{
                    enabled: false
                }
            },
            hover: {
                mode: null
            }
        };
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'CPU Load %',
                data: cpuData,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.3,
                pointRadius: 3,
                spanGaps: true,
                fill: true
            }]
        },
        options: options
    });
}

// Aggiorna i dati del grafico
async function updateChart() {
    try {
        const response = await fetch('/api/system_status');
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        const load = parseFloat(data.load);
        
        if (isNaN(load)) throw new Error('Invalid data format');

        // Aggiungi nuovo dato
        const now = new Date();
        timeLabels.push(now.toLocaleTimeString());
        cpuData.push(load);

        // Mantieni massimo 30 punti
        if (timeLabels.length > maxDataPoints) {
            timeLabels.shift();
            cpuData.shift();
        }

        // Calcola il massimo valore attuale (escludendo null)
        const validData = cpuData.filter(v => v !== null);
        const currentMax = validData.length ? Math.max(...validData) : 25;

        // Determina il massimo dell'asse Y
        let yMax = 25;
        if (currentMax >= 25 && currentMax <= 50) yMax = 50;
        if (currentMax >= 50 && currentMax <= 75) yMax = 75;
        else if (currentMax >= 75) yMax = 100;

        // Aggiorna le opzioni dell'asse Y
        chart.options.scales.y.max = yMax;
        chart.options.scales.y.ticks.stepSize = yMax === 100 ? 25 : yMax/2;

        // Aggiorna il grafico
        chart.data.labels = timeLabels;
        chart.data.datasets[0].data = cpuData;
        chart.update();

    } catch (error) {
        console.log(`Error: ${error.message}`);
    }
}

// Avvia l'aggiornamento ogni secondo
initChart();
setInterval(updateChart, 1800);

</script>
{% endblock %}
